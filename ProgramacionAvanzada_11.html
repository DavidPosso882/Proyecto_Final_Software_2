<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Programaci√≥n Avanzada | Gu√≠as y material de clase del espacio acad√©mico Programaci√≥n Avanzada.</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Programaci√≥n Avanzada" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gu√≠as y material de clase del espacio acad√©mico Programaci√≥n Avanzada." />
<meta property="og:description" content="Gu√≠as y material de clase del espacio acad√©mico Programaci√≥n Avanzada." />
<link rel="canonical" href="https://caflorezvi.github.io/guias-programacion-avanzada/11.consultas.html" />
<meta property="og:url" content="https://caflorezvi.github.io/guias-programacion-avanzada/11.consultas.html" />
<meta property="og:site_name" content="Programaci√≥n Avanzada" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Programaci√≥n Avanzada" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Gu√≠as y material de clase del espacio acad√©mico Programaci√≥n Avanzada.","headline":"Programaci√≥n Avanzada","url":"https://caflorezvi.github.io/guias-programacion-avanzada/11.consultas.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/guias-programacion-avanzada/assets/css/style.css?v=a62d04ee3adb9a99e7da2a479205ad5bc5247f42">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/guias-programacion-avanzada/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://caflorezvi.github.io/guias-programacion-avanzada/">Programaci√≥n Avanzada</a></h1>
      

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Programa de Ingenier√≠a de Sistemas y Computaci√≥n
Universidad del Quind√≠o

T√≠tulo: Consultas en Spring Data JPA
Duraci√≥n estimada: 120
Docentes: Carlos Andr√©s Florez, Christian Andr√©s Candela
Gu√≠a: 11
</code></pre></div></div>

<h1 id="consultas-en-spring-data-jpa">Consultas en Spring Data JPA</h1>

<h2 id="-objetivo">üéØ Objetivo</h2>
<p>Aprender a crear consultas b√°sicas a una base de datos relacional por medio de Spring Data JPA.</p>

<hr />

<h2 id="conceptos-b√°sicos">Conceptos b√°sicos</h2>

<ul>
  <li><strong>Bases de Datos SQL</strong>: MariaDB como ejemplo principal.</li>
  <li><strong>Java</strong>: Lenguaje de programaci√≥n orientado a objetos.</li>
  <li><strong>Spring Data JPA</strong>: M√≥dulo de Spring para interactuar con bases de datos SQL.</li>
</ul>

<hr />

<h2 id="contextualizaci√≥n-te√≥rica">Contextualizaci√≥n Te√≥rica</h2>

<p>Spring Data JPA es un proyecto del ecosistema Spring que proporciona una abstracci√≥n de alto nivel para la interacci√≥n con la base de datos relacionales en aplicaciones Java basadas en Spring. Su objetivo principal es simplificar el acceso a datos y reducir la cantidad de c√≥digo necesario para realizar operaciones comunes de base de datos.</p>

<h3 id="caracter√≠sticas-clave-de-spring-data-jpa">Caracter√≠sticas clave de Spring Data JPA</h3>

<ul>
  <li>
    <p><strong>Abstracci√≥n de Repositorios:</strong> Proporciona un conjunto de interfaces de repositorio que permiten realizar operaciones comunes de CRUD (Crear, Leer, Actualizar, Borrar) sin tener que escribir consultas espec√≠ficas de SQL. Esto se logra mediante la inferencia de consultas basada en convenciones de nombres de m√©todos.</p>
  </li>
  <li>
    <p><strong>Mapeo de Objetos a Tablas Relacionales:</strong> Simplifica el mapeo de objetos Java a tablas en bases de datos relacionales. Se pueden anotar las clases de entidad con anotaciones de Spring Data y JPA, y el mapeo entre las propiedades de los objetos y las columnas de las tablas se realiza autom√°ticamente.</p>
  </li>
  <li>
    <p><strong>Soporte para Consultas Derivadas:</strong> La inferencia de consultas permite construir consultas de SQL a partir de los nombres de los m√©todos en las interfaces de repositorio. Por ejemplo, al definir un m√©todo llamado <code class="language-plaintext highlighter-rouge">findByNombre(String nombre)</code>, Spring Data JPA generar√° autom√°ticamente una consulta para buscar registros donde el campo ‚Äúnombre‚Äù coincida.</p>
  </li>
  <li>
    <p><strong>Soporte para Transacciones:</strong> Spring Data JPA se integra con el soporte de transacciones de Spring, lo que facilita la gesti√≥n de transacciones en las operaciones de base de datos.</p>
  </li>
</ul>

<p>Cuando se utiliza Spring Boot en combinaci√≥n con Spring Data JPA y una base de datos relacional como MariaDB, se puede aprovechar la configuraci√≥n autom√°tica y las convenciones de Spring Boot para simplificar a√∫n m√°s el desarrollo de aplicaciones que interact√∫an con bases de datos.</p>

<h3 id="1-consultas-por-medio-de-la-inferencias">1. Consultas por medio de la inferencias</h3>

<p>La inferencia de queries en Spring Data JPA se refiere a la capacidad que tiene para generar consultas autom√°ticamente a partir de los nombres de los m√©todos en los repositorios. Utiliza convenciones de nomenclatura para analizar los nombres de los m√©todos y construir consultas SQL correspondientes.</p>

<p><strong>Por ejemplo</strong>, si tenemos un m√©todo en un repositorio llamado <code class="language-plaintext highlighter-rouge">findByEmail(String email)</code>, Spring Data JPA inferir√° la consulta para buscar registros que tengan el campo ‚Äúemail‚Äù coincidente.</p>

<p>Esto proporciona una forma m√°s concisa de definir consultas sin tener que escribir consultas SQL completas manualmente. La inferencia de queries simplifica el desarrollo al generar din√°micamente las consultas seg√∫n la firma del m√©todo en el repositorio.</p>

<h4 id="algunos-ejemplos">Algunos ejemplos:</h4>

<p>A continuaci√≥n, se presentan algunos ejemplos de c√≥mo se pueden definir m√©todos en un repositorio para que Spring Data JPA infiera las consultas correspondientes:</p>

<p><strong>Consulta por igualdad</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
</code></pre></div></div>
<p>Spring Data generar√° una consulta tipo: <code class="language-plaintext highlighter-rouge">SELECT * FROM user WHERE name = ?</code></p>

<p><strong>Consulta con operadores</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByAgeGreaterThan</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>

<p>Generar√° una consulta para encontrar usuarios cuya edad sea mayor que el valor proporcionado. Tambi√©n est√°n disponibles:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">findByAgeGreaterThanEqual</code> para mayor o igual</li>
  <li><code class="language-plaintext highlighter-rouge">findByAgeLessThan</code> para menor que</li>
</ul>

<p><strong>Consulta con m√∫ltiples condiciones</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByNameAndAge</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>
<p>Crear√° una consulta para encontrar usuarios con un nombre espec√≠fico y una edad dada. Tambi√©n est√°n disponibles los operadores <code class="language-plaintext highlighter-rouge">Or</code> y <code class="language-plaintext highlighter-rouge">Not</code>.</p>

<p><strong>Consulta por palabras clave (contenencia)</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByNameIsLike</span><span class="o">(</span><span class="nc">String</span> <span class="n">partOfName</span><span class="o">);</span>
</code></pre></div></div>

<p>Generar√° una consulta para encontrar usuarios cuyos nombres contengan la parte especificada.</p>

<p><strong>Ordenamiento</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByAgeGreaterThanOrderByNameAsc</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>
<p>Encontrar√° usuarios mayores que la edad proporcionada y los ordenar√° alfab√©ticamente por nombre ascendente.</p>

<p><strong>Conteo</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="nf">countByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>
<p>Contar√° el n√∫mero de usuarios con la edad dada.</p>

<p><strong>Paginaci√≥n de resultados</strong></p>

<p>Para paginar resultados, se pueden utilizar los m√©todos <code class="language-plaintext highlighter-rouge">findBy</code> junto con <code class="language-plaintext highlighter-rouge">Pageable</code> en los repositorios. Por ejemplo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>

<p>Esto permitir√° obtener una p√°gina de resultados que cumplan con la condici√≥n de edad, facilitando la implementaci√≥n de paginaci√≥n en la aplicaci√≥n. Cuando se utiliza <code class="language-plaintext highlighter-rouge">Pageable</code>, el resultado se envuelve en un objeto <code class="language-plaintext highlighter-rouge">Page</code>, que proporciona informaci√≥n adicional sobre la paginaci√≥n, como el n√∫mero total de p√°ginas y el n√∫mero total de elementos. Por ejemplo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span> <span class="c1">// P√°gina 0 con 10 elementos por p√°gina</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">usersPage</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">usersPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span> <span class="c1">// Obtener la lista de usuarios en la p√°gina</span>
<span class="kt">int</span> <span class="n">totalPages</span> <span class="o">=</span> <span class="n">usersPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">();</span> <span class="c1">// Obtener el n√∫mero total de p√°ginas</span>
<span class="kt">long</span> <span class="n">totalElements</span> <span class="o">=</span> <span class="n">usersPage</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">();</span> <span class="c1">// Obtener el n√∫mero total de elementos</span>
</code></pre></div></div>

<p><strong>Ordenamiento de resultados</strong></p>

<p>Para ordenar los resultados, se puede utilizar el par√°metro <code class="language-plaintext highlighter-rouge">Sort</code> en los m√©todos de consulta. Por ejemplo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
</code></pre></div></div>

<p>Esto permitir√° ordenar los resultados seg√∫n los criterios especificados en el objeto <code class="language-plaintext highlighter-rouge">Sort</code>. Cuando se utiliza <code class="language-plaintext highlighter-rouge">Sort</code>, se puede definir el ordenamiento por uno o m√°s campos, ya sea en orden ascendente o descendente, por ejemplo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span> <span class="c1">// Ordenar por nombre en orden ascendente</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="n">sort</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>Combinando paginaci√≥n y ordenamiento</strong></p>

<p>Si se necesita usar tanto paginaci√≥n como ordenamiento, se puede combinar <code class="language-plaintext highlighter-rouge">Pageable</code> y <code class="language-plaintext highlighter-rouge">Sort</code> de la siguiente manera:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">));</span> <span class="c1">// P√°gina 0 con 10 elementos por p√°gina, ordenados por nombre</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">usersPage</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">usersPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span> <span class="c1">// Obtener la lista de usuarios en la p√°gina</span>
</code></pre></div></div>

<h4 id="palabras-clave-comunes">Palabras clave comunes</h4>

<p>Hay varias palabras clave disponibles: <code class="language-plaintext highlighter-rouge">findBy</code>, <code class="language-plaintext highlighter-rouge">count</code>, <code class="language-plaintext highlighter-rouge">GreaterThan</code>, <code class="language-plaintext highlighter-rouge">LessThan</code>, <code class="language-plaintext highlighter-rouge">OrderBy</code>, <code class="language-plaintext highlighter-rouge">And</code>, <code class="language-plaintext highlighter-rouge">Or</code>. Para conocer todas las palabras claves √∫tiles se recomienda consultar la <a href="https://docs.spring.io/spring-data/jpa/reference/repositories/query-keywords-reference.html">documentaci√≥n oficial</a>.</p>

<h4 id="puntos-importantes-para-la-inferencia-de-queries">Puntos importantes para la inferencia de queries</h4>

<p>Para que la inferencia funcione correctamente, se debe tener en cuenta:</p>

<ul>
  <li>
    <p><strong>Convenciones de nomenclatura:</strong> Seguir las convenciones al definir los m√©todos en los repositorios. Utilizar nombres significativos que reflejen la operaci√≥n.</p>
  </li>
  <li>
    <p><strong>Tipos de retorno:</strong> Utilizar tipos de retorno apropiados en los m√©todos de repositorio. Se puede devolver Listas, Streams, DTO, u otros tipos seg√∫n las necesidades.</p>
  </li>
  <li>
    <p><strong>Campos de entidad:</strong> Asegurar que los nombres de los campos en las entidades coincidan con los utilizados en los m√©todos de repositorio.</p>
  </li>
  <li>
    <p><strong>Manejo de excepciones:</strong> Implementar manejo de excepciones adecuado para casos donde las consultas no puedan ser inferidas correctamente.</p>
  </li>
</ul>

<h3 id="2-consultas-personalizadas-con-query">2. Consultas personalizadas con <code class="language-plaintext highlighter-rouge">@Query</code></h3>

<p>En Spring Data JPA, la anotaci√≥n <code class="language-plaintext highlighter-rouge">@Query</code> se utiliza para definir consultas personalizadas en m√©todos de repositorio. A diferencia de la inferencia de consultas basada en convenciones de nombres, <code class="language-plaintext highlighter-rouge">@Query</code> permite escribir consultas JPQL o SQL nativas seg√∫n las necesidades.</p>

<h4 id="algunos-ejemplos-1">Algunos ejemplos</h4>

<p>A continuaci√≥n, se presentan algunos ejemplos de c√≥mo utilizar la anotaci√≥n <code class="language-plaintext highlighter-rouge">@Query</code> para definir consultas personalizadas en un repositorio:</p>

<p><strong>Consulta b√°sica</strong></p>

<p>Supongamos que tenemos una entidad llamada <code class="language-plaintext highlighter-rouge">User</code> con un campo <code class="language-plaintext highlighter-rouge">name</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT u FROM User u WHERE u.name = :name"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getListUsers</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
</code></pre></div></div>

<p>Este es un ejemplo de una consulta JPQL que selecciona usuarios por nombre. Aunque aparece similar a SQL, JPQL opera sobre entidades y sus propiedades en lugar de tablas y columnas, por lo tanto es independiente del motor de base de datos.</p>

<p>Dado que <code class="language-plaintext highlighter-rouge">User</code> es una entidad, <code class="language-plaintext highlighter-rouge">u</code> es un alias para la entidad y <code class="language-plaintext highlighter-rouge">u.name</code> se refiere a la propiedad <code class="language-plaintext highlighter-rouge">name</code> de la entidad.</p>

<p>Adem√°s, los par√°metros en la consulta se indican con <code class="language-plaintext highlighter-rouge">:</code> seguido del nombre del par√°metro.</p>

<p><strong>Consulta con m√∫ltiples condiciones</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT u FROM User u WHERE u.name = :name AND u.age = :age"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByNameAndAge</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>

<p>Retorna usuarios que coincidan con el nombre y la edad especificados.</p>

<p><strong>Consulta con conteo y agrupamiento</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT u.age, COUNT(u) FROM User u GROUP BY u.age"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">countUsersByAge</span><span class="o">();</span>
</code></pre></div></div>

<p>Cada elemento del resultado es un arreglo donde el primer elemento es la edad y el segundo es el conteo de usuarios con esa edad.</p>

<p><strong>Consulta con join</strong></p>

<p>En ciertas situaciones, es posible que necesitemos realizar consultas que involucren m√∫ltiples entidades relacionadas. Por ejemplo, si tenemos una entidad <code class="language-plaintext highlighter-rouge">Order</code> relacionada con <code class="language-plaintext highlighter-rouge">User</code>, podemos hacer un join:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT o FROM Order o JOIN o.user u WHERE u.id = :userId"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">findOrdersByUserId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">userId</span><span class="o">);</span>
</code></pre></div></div>

<p>En este caso, la entidad <code class="language-plaintext highlighter-rouge">Order</code> tiene una relaci√≥n con la entidad <code class="language-plaintext highlighter-rouge">User</code>, y estamos buscando √≥rdenes asociadas a un usuario espec√≠fico. Incluso, si la relaci√≥n es bidireccional, se puede hacer el join desde cualquiera de las dos entidades, por ejemplo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT o FROM User u JOIN u.orders o WHERE u.id = :userId"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">findOrdersByUserId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">userId</span><span class="o">);</span>
</code></pre></div></div>

<p>Las consultas personalizadas con <code class="language-plaintext highlighter-rouge">@Query</code> brindan flexibilidad, pero se debe ser consciente de que el lenguaje utilizado es JPQL, que es diferente de SQL. JPQL se basa en las entidades y sus relaciones, lo que permite escribir consultas de manera m√°s orientada a objetos (independiente del motor de base de datos). Pese a ello, JPQL cuenta con similitudes con SQL, tiene cl√°usulas como <code class="language-plaintext highlighter-rouge">SELECT</code>, <code class="language-plaintext highlighter-rouge">FROM</code>, <code class="language-plaintext highlighter-rouge">WHERE</code>, <code class="language-plaintext highlighter-rouge">JOIN</code>, <code class="language-plaintext highlighter-rouge">GROUP BY</code>, <code class="language-plaintext highlighter-rouge">ORDER BY</code>, entre otras.</p>

<p>Para m√°s detalles sobre JPQL, se recomienda consultar la <a href="https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html">documentaci√≥n oficial de JPA</a>.</p>

<h3 id="3-consultas-personalizadas-con-query-nativas">3. Consultas personalizadas con <code class="language-plaintext highlighter-rouge">@Query</code> nativas</h3>

<p>En Spring Data JPA, la anotaci√≥n <code class="language-plaintext highlighter-rouge">@Query</code> tambi√©n permite definir consultas SQL nativas utilizando el atributo <code class="language-plaintext highlighter-rouge">nativeQuery = true</code>. Esto es √∫til cuando se necesita aprovechar caracter√≠sticas espec√≠ficas del motor de base de datos o cuando la consulta es demasiado compleja para ser expresada en JPQL.</p>

<h4 id="ejemplo-de-consulta-nativa">Ejemplo de consulta nativa</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"SELECT * FROM users u WHERE u.age &gt; :age"</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findUsersAboveAge</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>
<p>En este ejemplo, se est√° utilizando una consulta SQL nativa para seleccionar usuarios cuya edad sea mayor que un valor espec√≠fico. El atributo <code class="language-plaintext highlighter-rouge">nativeQuery = true</code> indica que la consulta es SQL nativa.</p>

<h4 id="comparativa-entre-inferencia-de-queries-y-query">Comparativa entre inferencia de queries y <code class="language-plaintext highlighter-rouge">@Query</code></h4>

<p>En la siguiente tabla se resumen las diferencias entre ambos enfoques:</p>

<table>
  <thead>
    <tr>
      <th>Inferencia de Queries</th>
      <th>@Query Personalizado</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Facilidad de Uso:</strong> La inferencia a trav√©s de convenciones de nombres es f√°cil de usar y reduce la cantidad de c√≥digo necesario.</td>
      <td><strong>Flexibilidad:</strong> Permite consultas m√°s complejas y personalizadas que no pueden ser inferidas f√°cilmente.</td>
    </tr>
    <tr>
      <td><strong>Menos C√≥digo:</strong> No es necesario escribir consultas SQL completas, lo que puede reducir el c√≥digo y hacerlo m√°s legible.</td>
      <td><strong>Optimizaci√≥n:</strong> Se pueden optimizar las consultas seg√∫n los requisitos espec√≠ficos de rendimiento de la aplicaci√≥n.</td>
    </tr>
    <tr>
      <td><strong>Consistencia:</strong> Sigue las convenciones establecidas por Spring Data, haciendo el c√≥digo m√°s consistente.</td>
      <td><strong>Control Total:</strong> Proporciona un control total sobre la consulta, √∫til cuando se necesita un nivel m√°s granular de control.</td>
    </tr>
  </tbody>
</table>

<h3 id="4-consultas-usando-criteria-api">4. Consultas usando Criteria API</h3>

<p>La Criteria API es una caracter√≠stica de JPA que permite construir consultas de manera program√°tica utilizando una API fluida y orientada a objetos. A diferencia de JPQL o SQL, donde las consultas se escriben como cadenas de texto, la Criteria API permite construir consultas din√°micamente mediante la creaci√≥n de objetos y m√©todos.</p>

<p>Es especialmente √∫til cuando se necesita construir consultas de manera din√°mica en funci√≥n de ciertos criterios (como filtros de b√∫squeda) que pueden variar en tiempo de ejecuci√≥n.</p>

<p>Para usar la Criteria API, se suelen seguir estos pasos:</p>

<ol>
  <li>
    <p><strong>Obtener una instancia de <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>:</strong> Se obtiene a trav√©s del <code class="language-plaintext highlighter-rouge">EntityManager</code>. Es el punto de entrada para construir consultas.</p>
  </li>
  <li>
    <p><strong>Crear una instancia de <code class="language-plaintext highlighter-rouge">CriteriaQuery</code>:</strong> Se especifica el tipo de resultado que se espera (por ejemplo, una entidad espec√≠fica).</p>
  </li>
  <li>
    <p><strong>Definir la ra√≠z de la consulta:</strong> Se especifica la entidad desde la cual se realizar√° la consulta utilizando <code class="language-plaintext highlighter-rouge">Root&lt;T&gt;</code></p>
  </li>
  <li>
    <p><strong>Agregar condiciones y filtros:</strong> Se utilizan m√©todos del <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> para agregar condiciones a la consulta, como <code class="language-plaintext highlighter-rouge">where</code>, <code class="language-plaintext highlighter-rouge">and</code>, <code class="language-plaintext highlighter-rouge">or</code>, etc.</p>
  </li>
  <li>
    <p><strong>Ejecutar la consulta:</strong> Finalmente, se ejecuta la consulta utilizando el <code class="language-plaintext highlighter-rouge">EntityManager</code> para obtener los resultados.</p>
  </li>
</ol>

<p><strong>Ejemplo:</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">user</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="s">"John"</span><span class="o">));</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>Tenga en cuenta que la Criteria API puede ser m√°s verbosa y compleja en comparaci√≥n con JPQL o SQL, pero ofrece una mayor flexibilidad para construir consultas din√°micas y adaptarse a diferentes escenarios.</p>

<blockquote>
  <p>‚ö†Ô∏è <strong>Importante:</strong> En el proyecto final puede usar el enfoque que m√°s le guste o que considere m√°s adecuado. Hay total libertad.</p>
</blockquote>

<hr />

<h2 id="precauciones-y-recomendaciones">Precauciones y Recomendaciones</h2>

<ul>
  <li>Verificar que tiene instalado el JDK de Java (preferiblemente la versi√≥n 21)</li>
  <li>Asegurar que el servidor de base de datos (MariaDB) est√© corriendo.</li>
  <li>Cuando use <code class="language-plaintext highlighter-rouge">@Query</code>, aseg√∫rese de que las consultas est√©n correctamente formateadas y que los nombres de las entidades y campos coincidan con los definidos en su modelo.</li>
  <li>Cuando use inferencia de queries, siga las convenciones de nomenclatura para que Spring Data JPA pueda interpretar correctamente los nombres de los m√©todos.</li>
</ul>

<hr />

<h2 id="evaluaci√≥n-o-resultado">Evaluaci√≥n o Resultado</h2>

<p>Se espera que el estudiante entienda c√≥mo programar consultas b√°sicas en el proyecto de Spring Boot usando Spring Data JPA.</p>

<hr />

<h2 id="procedimiento">Procedimiento</h2>

<p>Realice los siguientes ejercicios en sus repositorios correspondientes. Adem√°s, programe el servicio y el controlador para que pueda probar la consulta desde Postman, Insomnia o archivos <code class="language-plaintext highlighter-rouge">.http</code>.</p>

<h3 id="1-consulta-por-ciudad-con-paginaci√≥n">1. Consulta por ciudad con paginaci√≥n</h3>
<p>Escriba una consulta que devuelva una lista de alojamientos dada una ciudad. Use <code class="language-plaintext highlighter-rouge">Pageable</code>.</p>

<h3 id="2-autenticaci√≥n-de-usuario">2. Autenticaci√≥n de usuario</h3>
<p>Construya una consulta que le permita obtener el usuario al que le correspondan unos datos de autenticaci√≥n (como por ejemplo email y contrase√±a).</p>

<h3 id="3-reportes-de-usuario-con-ordenamiento">3. Reportes de usuario con ordenamiento</h3>
<p>Escriba una consulta que permita obtener las reservas de un usuario dado su id. Haga que la lista se pueda ordenar seg√∫n la fecha (ascendente o descendentemente).</p>

<h3 id="4-b√∫squeda-por-texto-con-paginaci√≥n">4. B√∫squeda por texto con paginaci√≥n</h3>
<p>Escriba una consulta que permita obtener los alojamientos cuyo nombre contenga un texto dado ignorando may√∫sculas o min√∫sculas (use un paginador).</p>

<h3 id="5-consultas-personalizadas">5. Consultas personalizadas</h3>
<p>Cree al menos 5 consultas relacionadas a su proyecto y los respectivos m√©todos de prueba.</p>

<hr />

<h2 id="para-la-pr√≥xima-clase">Para la pr√≥xima clase</h2>

<ul>
  <li>Investigue sobre <code class="language-plaintext highlighter-rouge">JpaSpecificationExecutor</code>, identificando las ventajas que ofrece en comparaci√≥n con lo explicado en esta gu√≠a, as√≠ como las desventajas que presenta.</li>
  <li>Ampl√≠e la informaci√≥n sobre Criteria API, buscando ejemplos m√°s complejos y detallados.</li>
  <li>Investigue sobre las pruebas unitarias y su importancia. Puede buscar informaci√≥n sobre <strong>JUnit</strong> y <strong>Mockito</strong>.</li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
